# Cherry_DoIP 项目说明文档

## 项目概述

Cherry_DoIP 是一个基于 Python 的诊断协议 over IP (DoIP) 客户端应用程序，专门用于汽车 ECU（电子控制单元）测试和诊断。该应用程序提供了一个全面的图形界面，可以通过以太网向汽车 ECU 发送 UDS（统一诊断服务）命令，使用 DoIP 协议 (ISO 13400-2:2019)。

## 项目结构

```
Cherry_DoIP/
├── client.py              # 核心 DoIP 客户端实现
├── function.py            # DoIP 消息和工具函数
├── messages.py            # DoIP 消息类型和定义
├── constants.py           # 协议常量
├── MainWindow.py          # 主 GUI 应用程序
├── ui_DoIP.py             # 从 Qt Designer 生成的 UI 代码
├── DoIP.ui                # Qt Designer UI 文件
├── dtc.py                 # DTC（诊断故障码）解析器
├── chery_dict.py          # DIDs、DTCs 和编码的字典
├── security_access.py     # 安全访问（27 服务）实现
├── history_input.py       # 输入历史管理
├── config.toml            # 配置文件
├── requirements.txt       # Python 依赖项
└── tests/                 # 测试文件（已从此文档中排除）
```

## 核心组件

### 1. DoIP 客户端 (`client.py`)

DoIP 客户端实现提供了 DoIP 协议的完整 TCP/UDP 客户端：

- **传输层**: 处理与 ECU 的 TCP 和 UDP 通信
- **路由激活**: 实现与 ECU 的连接建立
- **消息处理**: 支持所有 DoIP 消息类型，包括诊断消息、车辆识别和路由控制
- **连接管理**: 处理 TCP 重新连接、套接字管理和连接状态
- **协议支持**: 符合 ISO 13400-2:2019 规范

主要功能：
- 可配置的 ECU 逻辑地址和 IP 地址
- 支持不同的激活类型（默认、监管、中央安全）
- 自动重连功能
- 支持 IPv4 和 IPv6

### 2. DoIP 消息 (`function.py`)

提供 UI 与 DoIP 客户端之间的核心接口：

- **DoIPMessage 类**: 发送 UDS 命令的高级接口
- **数据处理**: 十六进制字符串处理、UDS 响应验证的工具
- **安全访问**: 与安全访问功能的集成
- **实用函数**: 十六进制格式化、响应验证和字节操作

### 3. 消息定义 (`messages.py`)

包含所有 DoIP 消息类型定义，遵循 ISO 13400-2：

- **诊断消息**: UDS 命令/响应处理
- **车辆识别**: VIN、EID、GID 管理
- **路由控制**: 激活、停用和状态消息
- **状态报告**: 存活检查、电源模式、实体状态

### 4. GUI 界面 (`MainWindow.py`, `DoIP.ui`, `ui_DoIP.py`)

功能全面的 PySide6 界面，具有多个功能选项卡：

- **手动选项卡**: 自由格式十六进制命令输入（带历史记录）
- **自定义选项卡**: 用户可定义的常用命令按钮
- **应用服务选项卡**: UDS 服务按钮（会话、安全访问、DTC 控制等）
- **系统 DID 选项卡**: 车辆制造商数据标识符
- **ECU DID 选项卡**: ECU 特定数据标识符
- **DTC 选项卡**: 诊断故障码读取和分析
- **EOL 选项卡**: 端线测试功能
- **IO 控制选项卡**: 输入/输出控制功能


## 主要功能

### UDS 诊断服务支持

- **会话控制 (0x10)**: 默认和扩展诊断会话
- **ECU 重置 (0x11)**: 硬重置和软重置功能
- **安全访问 (0x27)**: 种子/密钥身份验证，使用 AES-CMAC
- **通信控制 (0x28)**: 启用/禁用通信
- **按 ID 读取数据 (0x22)**: 访问各种 DID
- **按 ID 写入数据 (0x2E)**: 配置和数据更新
- **输入/输出控制 (0x2F)**: 实时 I/O 操作
- **例程控制 (0x31)**: 启动/停止/请求例程执行
- **DTC 服务 (0x19)**: 读取、清除、控制诊断码
- **测试器存在 (0x3E)**: 保持活动功能

### DTC（诊断故障码）处理

- **DTC 解析器**: 解析 UDS 19 02 响应以识别当前和历史 DTC
- **DTC 字典**: DTC 代码映射到中文和英文描述的综合字典
- **基于状态的过滤**: 分离当前故障码和历史故障码
- **单个 DTC 搜索**: 特定故障码查找功能

### 安全访问

- **AES-CMAC 实现**: 使用 CMAC 和 AES-128 进行种子/密钥身份验证
- **可配置密钥**: 安全密钥存储在配置文件中
- **自动化处理**: 自动处理完整的 27 01/02 序列

### 配置分析

- **编码 DID (F011)**: 解析车辆配置字节，带详细的位级分析
- **配置字典**: 将配置位映射到人类可读的描述
- **字节级分析**: 分析 F011 响应中的特定配置字节

## 配置 (`config.toml`)

该应用程序使用 TOML 配置文件，包含以下部分：

### `[current]` 部分
- `ecu_ip_address`: ECU 的 IP 地址（默认：`"192.168.69.32"`）
- `ecu_logical_address`: ECU 的逻辑地址（默认：`0x07D0`）
- `ecu_functional_address`: 广播消息的功能地址（默认：`0xE40`）
- `tester_logical_address`: 测试器的逻辑地址（默认：`0x0E00`）
- `sec-key`: AES-CMAC 身份验证的安全密钥
- `log_level`: 日志级别（默认：`"INFO"`）

### `[undefined]` 部分
- 用户可配置按钮，带自定义名称和消息（按钮 1-20）

## 依赖项

该项目需要以下 Python 包：

- **PySide6**: 基于 Qt 的 GUI 框架
- **pycryptodome**: 安全访问的加密功能
- **loguru**: 高级日志功能
- **各种系统工具**: 用于网络操作和二进制数据处理
- **其他python库**

## GUI 选项卡功能

### 手动选项卡
- 自由十六进制命令输入（带发送功能）
- 以前发送命令的历史下拉列表
- 物理与功能寻址选择
- 路由激活类型选择

### 应用服务
- 会话管理（默认、扩展）
- 安全访问，自动处理种子/密钥
- ECU 重置功能
- 通信控制（带下拉选项）
- 例程控制（启动、停止、结果）
- DTC 控制（启用/禁用）
- 测试器存在（带自动重复）
- DTC 信息读取

### 系统 DID
- 车辆制造商信息（零件号、软件版本）
- 硬件和软件识别
- VIN 和车辆数据读取
- 某些 DID 的写入功能

### ECU DID
- ECU 特定数据标识符（57xx 范围）
- 各种 ECU 状态和配置数据
- 配置 DID 的写入功能

### DTC 分析
- 批量 DTC 读取和解析
- 单个 DTC 查找
- 清除所有 DTC 功能（服务 14）

### EOL 测试
- 专用的端线功能
- 配置检查和车辆编程

### IO 控制
- 输入/输出状态控制和监控
- 实时 I/O 操作

### 配置分析
- F011 读取和位级分析
- 车辆配置解码

## 使用方法

1. **配置**: 使用正确的 ECU IP 和地址设置 `config.toml` 文件
2. **连接**: 确保与目标 ECU 的网络连接
3. **激活**: 客户端在连接时自动执行路由激活
4. **通信**: 使用 GUI 发送 UDS 命令或手动输入十六进制命令
5. **分析**: 使用 DTC 和配置分析工具进行车辆诊断

## 安全功能

- **AES-CMAC 身份验证**: 为安全访问（服务 27）实现安全的种子/密钥交换
- **可配置密钥**: 安全密钥存储在配置中的源代码之外
- **加密通信**: 支持 TLS（在当前实现中未测试）

## 日志

- **全面日志**: 使用 loguru 进行详细日志记录，支持不同级别
- **ANSI 颜色支持**: GUI 日志显示中的彩色输出
- **可配置级别**: 日志级别可以在配置中调整

此文档涵盖了 Cherry_DoIP 项目的所有主要功能，提供了其架构、功能和在汽车诊断应用中使用的全面概述。